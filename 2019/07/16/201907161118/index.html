<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#4fc08d"><meta name="msapplication-TileColor" content="#4fc08d"><title> 论如何保护安卓的DNS · Just4fun</title><meta name="description" content="论如何保护安卓的DNS - coolrc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://coolrc.me/atom.xml" title="Just4fun"><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71864657-1",'auto');ga('send','pageview');</script><script src="//code.jquery.com/jquery-2.2.0.min.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.min.css"><script src="/js/jquery.fancybox.min.js"></script><script src="/js/wrapimage.js"></script></head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/friends/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/coolrc136" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">论如何保护安卓的DNS</h1><div class="post-info">Jul 16, 2019</div><div class="post-content"><p><img src="https://coolrc-blog.oss-cn-shenzhen.aliyuncs.com/superbed/2019/07/16/5d2d4c70451253d178527789.jpg" alt=""><br>传统的UDP DNS泄漏隐私，容易被篡改。尤其是隐私问题，你的运营商可以轻易知道你访问过哪些网站，想想都可怕。因此加密DNS显得尤为重要。<a id="more"></a><br>当然，DNS只是你访问互联网的第一个步骤而已，加密DNS并不能保证万无一失。HTTP自不必说，对于HTTPS，当你和服务器握手时，SNI也会暴露你访问的域名。但是，这并不代表加密dns没有用，至少在我朝网络环境下，可以保证DNS不被篡改，减少攻击面。</p>
<p class="tip">在TLS1.3中已经可以加密SNI了，可以通过在firefox中开启ESNI实现，但是需要服务端和客户端都支持，预计还要几年才能普及。</p>

<p>在PC上，加密dns很简单，只需要下载一个<a href="https://simplednscrypt.org" target="_blank" rel="noopener">SimpleDnsCrypt</a>,他就能自动帮你配好<code>dnscrypt-proxy</code>了。Linux的话，除了<code>dnscrypt-proxy</code>，还有<code>dns-overtls</code>和<code>dns-over-https</code>的各种软件可供选择。但是在安卓手机上，想要实现加密DNS就比较难了。</p>
<h2 id="dns-over-tls"><a href="#dns-over-tls" class="headerlink" title="dns-over-tls"></a>dns-over-tls</h2><p>从安卓9开始，就自带了加密dns功能，只要你在设置里填上合适的服务器地址就行，但是呢，这个自带的加密dns在使用代理时不会生效，如果你使用了SS，那么你还是会用SS里的DNS服务器明文查询，而且只能填一个域名，容易出故障。</p>
<h2 id="dnscrypt-proxy"><a href="#dnscrypt-proxy" class="headerlink" title="dnscrypt-proxy"></a>dnscrypt-proxy</h2><p>为了让全局DNS都能加密，这里就要使用一个<code>magisk</code>模块了，那就是<code>dnscrypt-proxy</code>。这个是<code>dnscrypt-proxy</code>的ARM版本，用<code>magisk</code>刷入，然后修改位于<code>/sdcard/dnscrypt-proxy</code>目录下的文件就能启用了。</p>
<p></p><p class="tip">为了方便配置，你可以在PC端用<code>SimpleDnsCrypt</code>配置好，然后把配置文件<code>dnscrypt-proxy.toml</code>复制过去。PC端默认监听53端口，建议修改为5353端口</p><br>这是我的配置文件：<p></p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server_names</span> = [<span class="string">"rubyfish-ea"</span>, <span class="string">"geekdns-doh-west"</span>, <span class="string">"geekdns-doh-north"</span>, <span class="string">"geekdns-doh-east"</span>]</span><br><span class="line"><span class="attr">listen_addresses</span> = [<span class="string">"127.0.0.1:53"</span>, <span class="string">"[::1]:53"</span>]</span><br><span class="line"><span class="attr">max_clients</span> = <span class="number">250</span></span><br><span class="line"><span class="attr">ipv4_servers</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">ipv6_servers</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">disabled_server_names</span> = []</span><br><span class="line"><span class="attr">refused_code_in_responses</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">dnscrypt_servers</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">doh_servers</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">require_dnssec</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">require_nolog</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">require_nofilter</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">daemonize</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">force_tcp</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">dnscrypt_ephemeral_keys</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">tls_disable_session_tickets</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">offline_mode</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">2500</span></span><br><span class="line"><span class="attr">keepalive</span> = <span class="number">30</span></span><br><span class="line"><span class="attr">lb_estimator</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">netprobe_timeout</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">netprobe_address</span> = <span class="string">"9.9.9.9:53"</span></span><br><span class="line"><span class="attr">log_level</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">use_syslog</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">cert_refresh_delay</span> = <span class="number">240</span></span><br><span class="line"><span class="attr">fallback_resolver</span> = <span class="string">"223.5.5.5:53"</span></span><br><span class="line"><span class="attr">ignore_system_dns</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">log_files_max_size</span> = <span class="number">10</span></span><br><span class="line"><span class="attr">log_files_max_age</span> = <span class="number">7</span></span><br><span class="line"><span class="attr">log_files_max_backups</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">block_ipv6</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">cache</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">cache_size</span> = <span class="number">256</span></span><br><span class="line"><span class="attr">cache_min_ttl</span> = <span class="number">600</span></span><br><span class="line"><span class="attr">cache_max_ttl</span> = <span class="number">86400</span></span><br><span class="line"><span class="attr">cache_neg_ttl</span> = <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="section">[query_log]</span></span><br><span class="line"><span class="attr">format</span> = <span class="string">"ltsv"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[nx_log]</span></span><br><span class="line"><span class="attr">format</span> = <span class="string">"ltsv"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[blacklist]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ip_blacklist]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[sources]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[sources.public-resolvers]</span></span><br><span class="line"><span class="attr">urls</span> = [<span class="string">"https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v2/public-resolvers.md"</span>, <span class="string">"https://download.dnscrypt.info/resolvers-list/v2/public-resolvers.md"</span>]</span><br><span class="line"><span class="attr">minisign_key</span> = <span class="string">"RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3"</span></span><br><span class="line"><span class="attr">cache_file</span> = <span class="string">"public-resolvers.md"</span></span><br><span class="line"><span class="attr">refresh_delay</span> = <span class="number">72</span></span><br><span class="line"><span class="attr">prefix</span> = <span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>然后，你有两个选择，一是安装一个修改dns的app，将dns指向dnscrypt-proxy监听的地址，比如我这里是<code>127.0.0.1:5353</code>，填进去，然后app一般会启动一个vpn，用这个vpn上网就行。<br>如果不想用vpn，那么可以安装<a href="https://coolrc-blog.oss-cn-shenzhen.aliyuncs.com/files/CloudflareDNS4Magisk-v2.6.zip" target="_blank" rel="noopener">这个magisk模块</a>,这个模块会使用<code>iptables</code>把所有53端口的出口流量转到<code>127.0.0.1:5353</code>，也就是全局启用了<code>dnscrypt-proxy</code>。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>配置完dns后，我们来测试一下有没有成功,访问<a href="https://www.dnsleaktest.com/" target="_blank" rel="noopener">https://www.dnsleaktest.com/</a>或者<a href="http://nstool.netease.com/" target="_blank" rel="noopener">http://nstool.netease.com/</a>。如果看到的DNS和你在<code>dnscrypt-proxy</code>中配置的一样，恭喜你，你的DNS已经被加密了。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://www.hetianlab.com/html/news/news-2018042001.html" target="_blank" rel="noopener">浅析加密DNS</a></p>
</div><div class="post-info">last updated: Jul 16, 2019</div><a class="post-info" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">许可协议: "署名-非商用-相同方式共享 4.0" 转载请保留原文链接及作者。</a></article></div></section><footer><nav id="pagination"><a class="prev" href="/2020/02/05/202002051/"><span>新建了个doh+dot服务器</span></a><a class="prev" href="/2019/07/16/201907160958/"><span>给波兰版MIUI用上国内主题</span></a></nav><div id="vssue"></div><link rel="stylesheet" href="https://unpkg.com/vssue/dist/vssue.min.css"><script src="https://unpkg.com/vue/dist/vue.min.js"></script><script src="https://unpkg.com/vssue/dist/vssue.github.min.js"></script><script>new Vue({
    el: '#vssue',

    data: {
        title: '论如何保护安卓的DNS',

        options: {
        owner: 'coolrc136',
        repo: 'blog_comment',
        clientId: '54a5c97e932cd5f13660',
        clientSecret: '475f010e505f0b656e6c8d2def4fc46237021a5b', // only required for some of the platforms
        },
    },

    template: `<vssue :title="title" :options="options"></vssue>`,
})</script><div class="copyright"><p>© 2015 - 2021 <a href="https://coolrc.me">coolrc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><p><a href="http://www.beian.miit.gov.cn/" target="_blank">陕ICP备19007986号</a>.</p></div></footer></div></body></html>